apiVersion: apps/v1
kind: Deployment
metadata:
  name: costq-fastapi
  namespace: costq-fastapi
  labels:
    app: costq-fastapi
    component: application
    environment: production
  annotations:
    description: "CostQ - AWS Intelligent Assistant (FastAPI Backend)"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: costq-fastapi
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: costq-fastapi
        component: application
        environment: production
      annotations:
        description: "CostQ - AWS Intelligent Assistant (FastAPI Backend)"
    spec:
      serviceAccountName: costq-fastapi-sa
      shareProcessNamespace: true
      terminationGracePeriodSeconds: 60

      containers:
      # ========== Nginx Container ==========
      - name: nginx
        image: 000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/costq-fastapi:nginx-latest
        imagePullPolicy: Always
        ports:
        - name: http
          containerPort: 80
          protocol: TCP

        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

        # Startup Probe (容器启动探针)
        startupProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 20
          periodSeconds: 15
          timeoutSeconds: 3
          failureThreshold: 40

        # Liveness Probe (存活探针)
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 0
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3

        # Readiness Probe (就绪探针)
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 2
          successThreshold: 1

        # PreStop Hook (优雅停止)
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - |
                # Send quit signal to nginx
                nginx -s quit
                # Wait for nginx to finish handling requests
                while killall -0 nginx 2>/dev/null; do
                  sleep 1
                done

        # Volume Mounts
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf

      # ========== App Container ==========
      - name: app
        image: 000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/costq-fastapi:app-latest
        imagePullPolicy: Always
        ports:
        - name: api
          containerPort: 8000
          protocol: TCP

        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi

        # Environment Variables (从 ConfigMap 和 Secret)
        env:
        - name: ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: costq-fastapi-config
              key: ENVIRONMENT
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: costq-fastapi-config
              key: DEBUG
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: costq-fastapi-config
              key: LOG_LEVEL
        - name: FASTMCP_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: costq-fastapi-config
              key: FASTMCP_LOG_LEVEL
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: costq-fastapi-config
              key: AWS_DEFAULT_REGION
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: costq-fastapi-config
              key: DATABASE_URL
              optional: true
        - name: JWT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: costq-fastapi-secrets
              key: JWT_SECRET_KEY
              optional: true

        # Load all ConfigMap and Secret values
        envFrom:
        - configMapRef:
            name: costq-fastapi-config
        - secretRef:
            name: costq-fastapi-secrets

        # Startup Probe (容器启动探针)
        startupProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 15
          periodSeconds: 15
          timeoutSeconds: 3
          failureThreshold: 40

        # Liveness Probe (存活探针)
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 0
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        # Readiness Probe (就绪探针)
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 2
          successThreshold: 1

        # PreStop Hook (优雅停止)
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - |
                # Send SIGTERM to all MCP server processes
                pkill -TERM -f 'mcp.*server' || true
                # Wait for subprocesses to exit
                sleep 10

      # ========== Volumes ==========
      volumes:
      - name: nginx-config
        configMap:
          name: costq-fastapi-nginx-config
